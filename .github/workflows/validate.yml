name: GitOps Validation

on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint and Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_file: .yamllint.yml

      - name: Check Kubernetes best practices
        uses: stackrox/kube-linter-action@v1
        with:
          config: .kube-linter.yml
          directory: |
            1-cluster-infra
            2-environments
            3-apps
          format: sarif
          output-file: kube-linter.sarif
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: kube-linter.sarif

  validate:
    name: Kustomize and Structure Validation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install kustomize
        run: |-
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate Kustomize overlays
        run: |
          find 3-apps -name kustomization.yaml -print0 | while IFS= read -r -d $'\0' file; do
            dir=$(dirname "$file")
            echo "Validating kustomization in $dir"
            kustomize build "$dir" || exit 1
          done

      - name: Check for native Secrets
        run: |
          if grep -r "kind: Secret" .; then
            echo "Error: Native Kubernetes Secrets are not allowed. Please use ExternalSecrets."
            exit 1
          fi

      - name: Validate repository structure
        run: |
          for app in 3-apps/*; do
            if [ -d "$app" ]; then
              if [ ! -d "$app/base" ] || [ ! -d "$app/overlays" ]; then
                echo "Error: $app must have a 'base' and 'overlays' directory."
                exit 1
              fi
              if [ ! -d "$app/overlays/development" ] || [ ! -d "$app/overlays/staging" ] || [ ! -d "$app/overlays/production" ]; then
                echo "Error: $app must have 'development', 'staging', and 'production' overlays."
                exit 1
              fi
            fi
          done

      - name: Validate ArgoCD Application paths
        run: |
          # This is a more complex script, for now we will just have a placeholder
          echo "Validation of ArgoCD Application paths would be implemented here."