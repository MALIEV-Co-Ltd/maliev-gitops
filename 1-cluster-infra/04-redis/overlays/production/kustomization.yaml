apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: maliev-prod

resources:
  - ../../base

# Production-specific patches
patches:
  - target:
      kind: StatefulSet
      name: redis
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 200m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 2Gi
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 5Gi

  - target:
      kind: ConfigMap
      name: redis-config
    patch: |-
      - op: replace
        path: /data/redis.conf
        value: |
          # Redis configuration for MALIEV production
          maxmemory 1536mb
          maxmemory-policy allkeys-lru
          save ""
          appendonly yes
          appendfsync everysec
          protected-mode no
          bind 0.0.0.0
          port 6379
          tcp-backlog 511
          timeout 0
          tcp-keepalive 300
          loglevel notice
          # Performance tuning
          slowlog-log-slower-than 10000
          slowlog-max-len 128

labels:
  - pairs:
      environment: production
