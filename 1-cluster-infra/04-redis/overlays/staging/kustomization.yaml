apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: maliev-staging

resources:
  - ../../base

# Staging-specific patches
patches:
  - target:
      kind: StatefulSet
      name: redis
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 2Gi

  - target:
      kind: ConfigMap
      name: redis-config
    patch: |-
      - op: replace
        path: /data/redis.conf
        value: |
          # Redis configuration for MALIEV staging
          maxmemory 512mb
          maxmemory-policy allkeys-lru
          save ""
          appendonly no
          protected-mode no
          bind 0.0.0.0
          port 6379
          tcp-backlog 511
          timeout 0
          tcp-keepalive 300
          loglevel notice

commonLabels:
  environment: staging
